name: CI

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false
      - name: Lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.0.2

  verify-crds:
    name: Verify CRDs
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Verify CRDs are up to date
        run: |
          make manifests
          git diff --exit-code config/crd/bases
          git diff --exit-code charts/uptime-robot-operator/crds

  test:
    name: Test
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Test
        run: make test
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./cover.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  security-scan-pr:
    name: Security Scan (PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [lint, verify-crds, test]
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Image (no push)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          pull: true
          push: false
          load: true
          tags: ghcr.io/${{ github.repository_owner }}/uptime-robot-operator:pr-${{ github.event.pull_request.number }}
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # Security Scanning and SBOM Generation for PRs
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/uptime-robot-operator:pr-${{ github.event.pull_request.number }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run Trivy vulnerability scanner (table format)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/uptime-robot-operator:pr-${{ github.event.pull_request.number }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
      
      - name: Generate SBOM (SPDX)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/uptime-robot-operator:pr-${{ github.event.pull_request.number }}
          format: 'spdx-json'
          output: 'sbom-spdx.json'
      
      - name: Generate SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/uptime-robot-operator:pr-${{ github.event.pull_request.number }}
          format: 'cyclonedx'
          output: 'sbom-cyclonedx.json'
      
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-pr-${{ github.event.pull_request.number }}
          path: |
            sbom-spdx.json
            sbom-cyclonedx.json

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, verify-crds, test]
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
      id-token: write  # Required for cosign keyless signing
      security-events: write  # Required for uploading SARIF results
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/uptime-robot-operator
          tags: |
            type=raw,priority=1000,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=beta,enable=${{ github.ref_name == 'main' }}
            type=ref,event=tag
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
      # NOTE: The scan gate intentionally only builds/scans linux/amd64 for performance;
      # ARM variants (linux/arm/v7, linux/arm64/v8) are built later without pre-push scanning.
      - name: Build Image (scan gate, no push)
        id: build_scan
        uses: docker/build-push-action@v6
        with:
          context: .
          pull: true
          push: false
          load: true
          platforms: linux/amd64
          tags: uptime-robot-operator:scan-${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: uptime-robot-operator:scan-${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy vulnerability scanner (table format)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: uptime-robot-operator:scan-${{ github.sha }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Build and Push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          pull: true
          push: ${{ steps.meta.outputs.tags != '' }}
          platforms: linux/amd64,linux/arm/v7,linux/arm64/v8
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha
            type=registry,ref=uptime-robot-operator:scan-${{ github.sha }}
          cache-to: type=gha,mode=max
      
      - name: Generate SBOM (SPDX)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/uptime-robot-operator@${{ steps.build.outputs.digest }}
          format: 'spdx-json'
          output: 'sbom-spdx.json'
      
      - name: Generate SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/uptime-robot-operator@${{ steps.build.outputs.digest }}
          format: 'cyclonedx'
          output: 'sbom-cyclonedx.json'
      
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: |
            sbom-spdx.json
            sbom-cyclonedx.json
      
      # Image Signing with Cosign
      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0
      
      - name: Sign container images
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          for tag in ${TAGS}; do
            echo "Signing ${tag}"
            cosign sign --yes "${tag}"
          done
      
      - name: Attest SBOM to images
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          for tag in ${TAGS}; do
            echo "Attesting SBOM to ${tag}"
            cosign attest --yes --predicate sbom-spdx.json --type spdx "${tag}"
            cosign attest --yes --predicate sbom-cyclonedx.json --type cyclonedx "${tag}"
          done

  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [lint, test, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate Changelog
        id: changelog
        uses: gabe565/changelog-generator@v1
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.changelog }}

  release-manifests:
    name: Release Manifests
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [lint, test, build]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@v2.5.1
      - name: Generate Installer
        run: make build-installer IMG=ghcr.io/${{ github.repository_owner }}/uptime-robot-operator:${{ github.ref_name }}
      - name: Publish
        run: |
          flux push artifact \
            oci://ghcr.io/${{ github.repository_owner }}/uptime-robot-operator-manifests:${{ github.ref_name }} \
            --path=dist --source=${{ github.repositoryUrl }} --revision="${{ github.ref_name }}@sha1:${{ github.sha }}"

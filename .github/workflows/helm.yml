---
name: Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'charts/**'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint chart
        run: helm lint charts/uptime-robot-operator/

  template:
    name: Template
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Template chart (default values)
        run: helm template test-release charts/uptime-robot-operator/

      - name: Template chart (custom values)
        run: |
          helm template test-release charts/uptime-robot-operator/ \
            --set replicaCount=2 \
            --set image.tag=v1.0.0 \
            --set metrics.enabled=false

  install-test:
    name: Install Test
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: chart-test

      - name: Install chart
        run: |
          helm install uptime-robot charts/uptime-robot-operator/ --wait --timeout 2m

      - name: Verify installation
        run: |
          kubectl get pods -n uptime-robot-system
          kubectl wait --for=condition=Available deployment -l app.kubernetes.io/name=uptime-robot-operator -n uptime-robot-system --timeout=60s

      - name: Verify CRDs installed
        run: |
          kubectl get crd accounts.uptimerobot.com
          kubectl get crd contacts.uptimerobot.com
          kubectl get crd monitors.uptimerobot.com

      - name: Test upgrade
        run: |
          helm upgrade uptime-robot charts/uptime-robot-operator/ \
            --set replicaCount=2 \
            --wait --timeout 2m

      - name: Verify upgrade
        run: |
          kubectl get pods -n uptime-robot-system
          # Should have 2 replicas now
          kubectl get deployment -n uptime-robot-system -o jsonpath='{.items[0].spec.replicas}' | grep -q "2"

      - name: Test uninstall
        run: |
          helm uninstall uptime-robot
          # CRDs should still exist (keep: true)
          kubectl get crd accounts.uptimerobot.com
